# BGM 永続化の設計メモ

このプロジェクトでは、ゲーム全体で BGM をページ遷移により停止させない設計を採用します。目的はシームレスな音楽体験を提供することです。

## 方針

- 可能な限り SPA (シングルページアプリ) スタイルの `router` を使って画面遷移を行い、`<audio id="bgm">` を単一の DOM として維持します。
- ページを完全にリロードする場合は BGM は停止します。ブラウザの仕様上これは避けられません。
- router がない場合は、遷移前にフェードアウト表現を使い、視覚的な切替を行ってから `location.href` に遷移しますが、BGM は停止します。

## 実装上の注意点

- `js/start.js` にある `ensureBgm()` のようなヘルパーで、`<audio id="bgm">` を一度だけ生成し、以降のページで再利用してください。
- `js/prologue.js` の `navigateTo()` は router が利用可能な場合に `window.router.navigate(url)` を呼びます。router が存在しない場合は `transitionAPI` を利用し、最終フォールバックで `window.location.href` を使用します。
- 自動再生ポリシー:
  - ブラウザはユーザー操作無しでの音声自動再生を制限します。BGM はユーザーの最初の操作（クリック等）に紐づけて再生開始する実装が推奨されます。
  - 再生がブロックされた場合は、UI で「音を再生する」ボタンや、最初の操作をトリガーにして再生処理を呼び出すと良いです。

## 関連ファイル

- `js/start.js` - BGM を作成/管理するヘルパー
- `js/prologue.js` - `navigateTo()` に設計コメントを追加
- （将来）`js/router.js` - SPA ルーターがある場合はここで遷移処理を実装

## 運用手順（短く）

1. サイトを SPA 化できる場合は `router` を導入する。既存のページリンクを `router.navigate()` 経由で行う。
2. どうしてもページ遷移が必要な場合は、遷移前に BGM をフェードアウトしてから遷移するなど UX 上のカバーを検討する。
3. 自動再生が阻害される場合は、初回のユーザー操作を利用して `bgm.play()` を呼ぶ。

---

このファイルはリポジトリ内の運用メモです。内容の更新や補足があれば随時編集してください。
